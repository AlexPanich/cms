(function() {
    tinymce.create('tinymce.plugins.GalleryPlugin', {
        init: function(ed) {
            var self = this;

            ed.on('beforeSetContent', function(e) {
                e.content = self['_toHTML'](e.content);
            });

            ed.on('postProcess', function(e) {
                if (e.set) {
                    e.content = self['_toHTML'](e.content);
                }

                if (e.get) {
                    e.content = self['_toWidget'](e.content);
                }
            });

            ed.addButton('gallery', {
                onclick: function () {
                    tinymce.util.XHR.send({
                        url: '/tynimce/gallery',
                        success: function (data) {
                            var galleries = JSON.parse(data);

                            var values = galleries.map(function (elem) {
                                return {
                                    text: elem.name,
                                    value: elem.name
                                }
                            })

                            ed.windowManager.open({
                                title: 'Вставить галерею',
                                buttons: [{
                                    text: 'Вставить',
                                    onclick: 'submit'
                                }, {
                                    text: 'Закрыть',
                                    onclick: 'close'
                                }],
                                body: [
                                    {
                                        type: 'combobox',
                                        name: 'combobox',
                                        label: 'Выберите галлерею',
                                        values: values
                                    }
                                ],

                                onsubmit: function (e) {
                                    if (e.data.combobox) {
                                        ed.insertContent('[[--widget/gallery/' + e.data.combobox + '--]]');
                                    }
                                }
                            });
                        }
                    });
                },
                text: 'Gallery',
                icon: false
            });
        },


        // Private methods

        // HTML -> Widget
        _toWidget: function(s) {
            s = tinymce.trim(s);
            function rep(re, str) {
                s = s.replace(re, str);
            }
            rep(/<img class="(.+?)" src="\/images\/icons\/(.+?)data-widget="(.+?)" data-name="(.+?)".+>/gi, '[[--widget/$3/$4--]]');

            return s;
        },

        // Widget -> HTML
        _toHTML: function(s) {
            s = tinymce.trim(s);
            function rep(re, str) {
                s = s.replace(re, str);
            }

            rep(/\[\[--widget\/(.+?)\/(.+?)--\]\]/gi, '<img src="/images/icons/gallery.png" data-widget="$1" data-name="$2" class="$1">');

            return s;
        }
    });

    // Register plugin
    tinymce.PluginManager.add('gallery', tinymce.plugins.GalleryPlugin);
})();